<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speed Calculator with Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
        }

        .container {
            text-align: center;
        }

        .info {
            font-size: 1.2em;
            margin-top: 10px;
        }

        #map {
            width: 80%;
            height: 400px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const toRadians = (degree) => (degree * Math.PI) / 180;

            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);

            const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in km
        }

        const MIN_DISTANCE_THRESHOLD = 0.01; // Minimum distance in km to consider a valid movement
        const EMA_ALPHA = 0.2; // Exponential moving average factor for smoothing speed
        const MIN_TIME_INTERVAL = 2000; // Minimum time in ms between updates

        let positionBuffer = [];
        let emaSpeed = 0;
        let map = null;
        let marker = null;

        function initializeMap(lat, lon) {
            map = L.map('map').setView([lat, lon], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([lat, lon]).addTo(map);
        }

        function updateLocation(lat, lon) {
            if (!map) {
                initializeMap(lat, lon);
            } else {
                map.setView([lat, lon], 15);
                marker.setLatLng([lat, lon]);
            }
        }

        function calculateSpeed() {
            if (positionBuffer.length < 2) {
                return 0; // Not enough data to calculate speed
            }

            const first = positionBuffer[0];
            const last = positionBuffer[positionBuffer.length - 1];

            const distance = haversine(
                first.latitude,
                first.longitude,
                last.latitude,
                last.longitude
            );

            const timeDiff = (last.time - first.time) / 1000; // in seconds

            if (distance < MIN_DISTANCE_THRESHOLD) {
                return 0; // Ignore small movements
            }

            const rawSpeed = (distance / timeDiff) * 3600; // km/h

            // Apply exponential moving average to smooth speed
            emaSpeed = EMA_ALPHA * rawSpeed + (1 - EMA_ALPHA) * emaSpeed;

            return emaSpeed;
        }

        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const currentTime = new Date().getTime();

                        // Ensure consistent time interval
                        if (positionBuffer.length > 0) {
                            const last = positionBuffer[positionBuffer.length - 1];
                            const timeDiff = currentTime - last.time;

                            if (timeDiff < MIN_TIME_INTERVAL) {
                                return; // Skip if interval is too short
                            }
                        }

                        positionBuffer.push({ latitude, longitude, time: currentTime });

                        // Keep only the last 10 positions
                        if (positionBuffer.length > 10) {
                            positionBuffer.shift(); // Remove the oldest position
                        }

                        updateLocation(latitude, longitude);

                        const speed = calculateSpeed();
                        document.getElementById('speed').innerText = `Current Speed: ${speed.toFixed(2)} km/h`;

                        document.getElementById('location').innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;
                    },
                    (error) => {
                        console.error('Error obtaining geolocation:', error);
                        document.getElementById('speed').innerText = 'Error obtaining geolocation data';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0,
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
                document.getElementById('speed').innerText = 'Geolocation not supported';
            }
        }
    </script>
</head>
<body onload="startTracking()">
    <div class="container">
        <h1>Speed Calculator with Map</h1>
        <div id="speed">Getting speed data...</div>
        <div class="info" id="location">Fetching location...</div>
        <div id="map"></div>
    </div>
</body>
</html>
